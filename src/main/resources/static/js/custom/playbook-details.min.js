var checkSendToApproval;function openFile(b){let fileData=new FormData();let displayUpload=$("#FileUpload").get(0);let displayfiles=displayUpload.files;for(let i=0;i<displayfiles.length;i++){fileData.append("file",displayfiles[i]);var a=new FileReader();a.self=this;a.name=displayfiles[i].name;a.type=displayfiles[i].type;a.onload=function(d){var c=getextensionfile(this.name);if(c){$("#getContenOfFile").html(this.result);$(".displayitem").html("");$(".displayitem").append("<span>"+this.name+"</span>")}else{$(".displayitem").html("");$("#getContenOfFile").html("");return false}};a.readAsText(displayfiles[i])}$.ajax({type:"POST",url:"/nera/upload/playbook/get-output",data:fileData,contentType:false,processData:false,beforeSend:function(){},success:function(c){$(".notstandard").remove();for(let i=0;i<c.length;++i){readOutputRow(c[i].variable,c[i].value)}},error:function(c){}})}function readOutputRow(a,b){$("#tblPlaybookOutput").removeClass("hideclass");$("#tblPlaybookOutput > tbody:last").append('<tr class="notstandard"><td style="text-align:center" class="outputVariable outPutResize">'+a+'</td><td style="text-align:center" class="outputValue outPutResize">'+b+"</td></tr>")}function getextensionfile(b){var d="";var c=false;if(b!=""){d=b.replace(/^.*\./,"");if(d=="yml"){c=true}}return c}var fileListing=[];function changeFunc(d){var b=d;$("#selectedFile").val(b);var a="";for(var c=0;c<fileListing.length;c++){if(fileListing[c].id==b){a=fileListing[c].filename;downloadFileCSV(a);reDownload();return false}}}function downloadFileCSV(a){$.ajax({url:"/nera/upload/downloadFile/"+a,type:"GET",xhrFields:{responseType:"blob"},success:function(d){var f=new Blob([d],{type:".yml"});if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(f,a)}else{var b=document.createElement("a");var c=window.URL.createObjectURL(d);b.href=c;b.download=a;b.click();window.URL.revokeObjectURL(c)}},error:function(b){console.log(b)}})}function reDownload(){$(".redownload").on("click",function(){var b=$(this).attr("data-id");$("#selectedFile").val(b);var a="";for(var c=0;c<fileListing.length;c++){if(fileListing[c].id==b){a=fileListing[c].filename;downloadFileCSV(a);return false}}})}function changeoftype(){var a=$("#selectedType").val();if(a==1){$("#changeofinput").removeClass("hideclass");$("#changeoftype").addClass("hideclass")}else{$("#changeofinput").addClass("hideclass");$("#changeoftype").removeClass("hideclass");$(".select2 .select2-selection--single").css("height","38px")}}genNavigation("playbook");$(document).ready(function(){$("#system-menu-left").removeClass("kt-menu__item--open");$("#dashboard-menu-left").removeClass("kt-menu__item--open");$("#workflow-menu-left").removeClass("kt-menu__item--open");$("#job-management-menu-left").removeClass("kt-menu__item--open");$("#job-planning-menu-left").removeClass("kt-menu__item--open");$("#my-job-menu-left").removeClass("kt-menu__item--open");k();function k(){var z=$("#getPlaybookid").val();if(z>0){$(".layCreate").removeClass("hideclass")}$("#selectedType").select2({width:"resolve",dropdownAutoWidth:true})}$("#btnAddInput").click(function(){$("#tblPlaybookInput").removeClass("hideclass");$("#tblAddInput").removeClass("hideclass")});n();function n(){$.ajax({type:"GET",url:"/nera/file-management/api/get-all",success:function(B){var A=B;var F=[];fileListing=A;var C=new Option("","");$("#selectedFile").append(C);F.push({id:"",text:""});for(var z=0;z<A.length;z++){var E=new Option(A[z].name,A[z].id);$("#selectedFile").append(E);var D="<div>"+A[z].name+'-<a href="#" data-id="'+A[z].id+'" class="redownload" style="color: blue;">'+A[z].filename+"</a></div>";F.push({id:A[z].id,text:D})}f(F);console.log(F)}})}function f(z){$("#selectedFileTest").select2({data:z,templateResult:function(A){return $(A.text)},templateSelection:function(A){return $(A.text)},selectionTitleAttribute:false});a();reDownload()}function a(){$(".select2-selection__rendered").hover(function(){$(this).removeAttr("title")})}$(".pldConfirm").on("click",function(){if($("#pldVariable").val().trim()==""){$("#pldVariable").removeClass("input-wrong");setTimeout(function(){$("#pldVariable").addClass("border border-danger input-wrong");$("#pldValue").removeClass("border border-danger input-wrong")},100);$("#spErrorInput").removeClass("hideclass")}else{$("#pldVariable").removeClass("border border-danger input-wrong");$("#pldValue").removeClass("border border-danger input-wrong");$("#spErrorInput").addClass("hideclass");d();$(".editingrow").remove()}});function d(){let ck=$("#selectedType").val();let col1=$("#selectedType option:selected").text().trim();let col11=$("#selectedType option:selected").val();let col2=$("#pldVariable").val();let checked=$("#pldMandatory").is(":checked");let col3;let col31;if(ck==1){col3=$("#pldValue").val();col31=""}else{col3=$("#selectedFile option:selected").text().trim();col31=$("#selectedFile option:selected").val()}l(col1,col11,col2,col3,col31,checked)}function l(D,E,C,B,z,A){let mandatory="";if(A==true||A==1){mandatory='<td class="resizeCol" style="vertical-align: middle;"><input style="transform: scale(1.5);" disabled="disabled" type="checkbox" class="mandatorychecked" data-id="'+A+'" checked></td>'}else{mandatory='<td class="resizeCol" style="vertical-align: middle;"><input style="transform: scale(1.5);" disabled="disabled" type="checkbox" class="mandatorychecked" data-id="'+A+'"></td>'}$("#tblPlaybookInput > tbody:last").append('<tr class="notstandard"><td style="text-align:center; vertical-align: middle" class="gettypevalue" data-id="'+E+'">'+D+'</td><td class="getvariable resizeCol" style="vertical-align: middle;">'+C+'</td><td class="getfilevalue resizeCol" style="vertical-align: middle;" data-id="'+z+'">'+B+"</td>"+mandatory+'<td style="padding-left:5%"><span><a href="#" class="btn btn-hover-brand btn-icon btn-pill pldEditRow"><i class="la la-pencil"></i></a></span><span><a href="#" class="btn btn-hover-danger btn-icon btn-pill pldDeleteRow"><i class="la la-trash"></i></a></span></td></tr>');$("#pldVariable").val("");$("#pldValue").val("");$("#selectedFile").val("");$("#selectedFileTest").val("").trigger("change");s();p()}function v(z,A){$("#tblPlaybookOutput").removeClass("hideclass");$("#tblPlaybookOutput > tbody:last").append('<tr class="notstandard"><td style="text-align:center; max-width:11em; word-wrap: break-word" class="outputVariable">'+z+'</td><td style="text-align:center; max-width:11em; word-wrap: break-word" class="outputValue">'+A+"</td></tr>")}function s(){$(".pldDeleteRow").on("click",function(){this.closest("tr").remove()})}function p(){$(".pldEditRow").unbind().on("click",function(C){C.stopPropagation();var E=$(this).closest("tr");var F=E.find(".gettypevalue").attr("data-id");var z=E.find(".getvariable").text().trim();var B=E.find(".getfilevalue").text().trim();var D=E.find(".getfilevalue").attr("data-id");var A=E.find(".mandatorychecked").is(":checked");$("#tblAddInput").removeClass("hideclass");r(F,z,B,D,A);$(".notstandard").removeClass("editingrow");E.addClass("editingrow")})}function r(D,z,B,C,A){$("#selectedType").val(D).trigger("change");$("#pldVariable").val(z);if(A==true){$("#pldMandatory").prop("checked",true)}else{$("#pldMandatory").prop("checked",false)}if(D==1){$("#pldValue").val(B)}else{$("#selectedFile").val(C).trigger("change")}}g();function g(){$("#btnCreateNewPlaybook").on("click",function(){checkSendToApproval=0;var A=$("#pldGetPlaybookName").val();if(A==""){$(".nameRequired").removeClass("hideclass");return false}else{$(".nameRequired").addClass("hideclass")}let ckf=false;if($(".displayitem").text().trim()!==""){ckf=true;$(".uploadRequired").addClass("hideclass")}else{$(".uploadRequired").removeClass("hideclass");e.stopImmediatePropagation()}var C=$("#FileUpload").get(0);var F=C.files;var D=[];$("#tblPlaybookInput tbody .notstandard").each(function(){var G={type:$(this).find(".gettypevalue").text().trim(),variable:$(this).find(".getvariable").text().trim(),value:$(this).find(".getfilevalue").text().trim(),mandatory:$(this).find(".mandatorychecked").is(":checked"),fileManagementId:$(this).find(".getfilevalue").attr("data-id")};D.push(G)});let playbookoutput=[];$("#tblPlaybookOutput tbody .notstandard").each(function(){var G={variable:$(this).find(".outputVariable").text().trim(),value:$(this).find(".outputValue").text().trim()};playbookoutput.push(G)});let fileData=new FormData();if(ckf){for(var B=0;B<F.length;B++){fileData.append("file",F[B])}}var z={name:$("#pldGetPlaybookName").val(),playbookInput:D,playbookOutput:playbookoutput,note:$("#pldNotes").val()};if($("#getPlaybookid").val()>0){z.status=$(".forstatus").attr("data-value");z.active=$("input[name=radio2]:checked").val()}else{z.status="NEW"}var E=0;if(ckf){E=F.length}let up=fileData;let cre=z;x(E,up,cre)});$("#btnCreateAndSendToApproved").on("click",function(){checkSendToApproval=1;var A=$("#pldGetPlaybookName").val();if(A==""){$(".nameRequired").removeClass("hideclass");return false}else{$(".nameRequired").addClass("hideclass")}let ckf=false;if($(".displayitem").text().trim()!=""){ckf=true;$(".uploadRequired").addClass("hideclass")}else{$(".uploadRequired").removeClass("hideclass");e.stopImmediatePropagation()}let fileUpload=$("#FileUpload").get(0);let files=fileUpload.files;let playbookinput=[];$("#tblPlaybookInput tbody .notstandard").each(function(){let filerecord={type:$(this).find(".gettypevalue").text().trim(),variable:$(this).find(".getvariable").text().trim(),value:$(this).find(".getfilevalue").text().trim(),mandatory:$(this).find(".mandatorychecked").is(":checked"),fileManagementId:$(this).find(".getfilevalue").attr("data-id")};playbookinput.push(filerecord)});let playbookinputconfirm=[];$("#tblPlaybookInput tbody .notstandard").each(function(){let filerecord={inputtype:$(this).find(".gettypevalue").text().trim(),variable:$(this).find(".getvariable").text().trim(),value:$(this).find(".getfilevalue").text().trim(),mandatory:$(this).find(".mandatorychecked").is(":checked")};playbookinputconfirm.push(filerecord)});var C=[];$("#tblPlaybookOutput tbody .notstandard").each(function(){var E={variable:$(this).find(".outputVariable").text().trim(),value:$(this).find(".outputValue").text().trim()};C.push(E)});let playbookOutputConfirm=[];$("#tblPlaybookOutput tbody .notstandard").each(function(){let filerecord={variable:$(this).find(".outputVariable").text().trim(),value:$(this).find(".outputValue").text().trim()};playbookOutputConfirm.push(filerecord)});let fileData=new FormData();if(ckf){for(var B=0;B<files.length;B++){fileData.append("file",files[B])}}var z={name:$("#pldGetPlaybookName").val(),playbookInput:playbookinput,playbookOutput:C,note:$("#pldNotes").val(),sendToApproved:true};if($("#getPlaybookid").val()>0){z.status=$(".forstatus").attr("data-value");z.active=$("input[name=radio2]:checked").val()}else{z.status="NEW"}b(z,playbookinputconfirm,playbookOutputConfirm);var D=0;if(ckf){D=files.length}let up=fileData;let cre=z;j(D,up,cre)})}function b(D,A,C){if(D.name==""){return false}$("#reName").text(D.name);if($("#getPlaybookid").val()>0){$("#reFile").html($(".displayitem").text().trim());$("#reFileContent").html($("#getContenOfFile").text().trim())}else{if($(".displayitem").text().trim()!=""){var F=$("#FileUpload").get(0);var E=F.files;if(E.length>0){var z=new FileReader();z.self=this;z.name=E[0].name;z.onload=function(G){$("#reFile").html(this.name);$("#reFileContent").html(this.result)};z.readAsText(E[0])}}}var B=A;$("#tblResultResponse > tbody").html("");for(let i=0;i<B.length;i++){m(B[i].inputtype,B[i].variable,B[i].value,B[i].mandatory)}$("#tblResultOuput > tbody").html("");for(let i=0;i<C.length;i++){u(C[i].letiable,C[i].value)}$("#addPlaybookConfirmation").modal("show")}function x(B,z,A){if($("#getPlaybookid").val()>0){A.id=$("#getPlaybookid").val();if(B>0){if($(".displayitem").text().trim()!=""){y(z,A)}}else{A.fileName=$(".displayitem").text().trim();A.sourceUrl=$(".displayitem").attr("data-value");w(A)}}else{if(B>0){y(z,A)}else{c(A)}}}function j(B,z,A){$("#btnResultResponse").unbind().click(function(){console.log("len of create obj : __________"+A.length);if($("#getPlaybookid").val()>0){A.id=$("#getPlaybookid").val();if(B>0){if($(".displayitem").text().trim()!=""){y(z,A)}}else{A.fileName=$(".displayitem").text().trim();A.sourceUrl=$(".displayitem").attr("data-value");w(A)}}else{if(B>0){y(z,A)}else{c(A)}}})}function y(z,A){$.ajax({type:"POST",url:"/nera/upload/playbook",data:z,contentType:false,processData:false,beforeSend:function(){},success:function(B){A.fileName=B.fileInfo.fileName;A.sourceUrl=B.fileInfo.fileDownloadUri;if($("#getPlaybookid").val()>0){w(A)}else{c(A)}},error:function(B){}})}function c(z){$("#save-failed").css("display","none");$("#save-failed").empty();$.ajax({type:"POST",url:"/nera/playbook/api/save",data:JSON.stringify(z),contentType:"application/json",beforeSend:function(){},success:function(A){$("#save-success").empty();if(checkSendToApproval==1){$("#addPlaybookConfirmation").modal("hide");$("#save-success").append("Request for Playbook approval has been sent successfully")}else{$("#save-success").append("Save successfully")}$("#save-success").css("display","block");$("#save-success").alert();setTimeout(function(){$("#save-success").css("display","none")},3000);q();setTimeout(function(){window.location.href="../playbook"},3000)},error:function(A){$("#save-failed").empty();if(A.status===400||A.status===500){$("#save-failed").append(A.responseJSON.detail)}else{$("#save-failed").append(A.statusText)}$("#save-failed").css("display","block");$("#save-failed").alert();setTimeout(function(){$("#save-failed").css("display","none")},3000)}})}function w(z){$("#save-failed").css("display","none");$("#save-failed").empty();$.ajax({type:"POST",url:"/nera/playbook/api/update",data:JSON.stringify(z),contentType:"application/json",success:function(A){q();$("#save-success").empty();let message="";if(checkSendToApproval==1){$("#addPlaybookConfirmation").modal("hide");message="Request for Playbook approval has been sent successfully"}else{message="Update successfully"}Swal.fire({text:message,type:"success",timer:3000,showConfirmButton:false});setTimeout(function(){window.location.href="../../playbook"},3000)},error:function(A){$("#save-failed").empty();let messageError="";if(A.status===400||A.status===500){messageError=A.responseJSON.detail}else{messageError=A.statusText}Swal.fire({text:messageError,type:"error",timer:3000,showConfirmButton:false})}})}function m(z,A,B,C){if(C==true){C='<td style="vertical-align: middle;"><input class="mandatorycheckbox" disabled="disabled" type="checkbox" checked="true"></td>'}else{C='<td class="resizeCol" style="vertical-align: middle;"><input disabled="disabled" type="checkbox"></td>'}$("#tblResultResponse > tbody:last").append('<tr><td class="textcen">'+z+'</td><td class="textcen" style="word-wrap: break-word; max-width: 200px;">'+A+'</td><td class="textcen" style="word-wrap: break-word; max-width: 200px;">'+B+"</td>"+C+"</tr>")}function u(z,A){$("#tblResultOuput > tbody:last").append('<tr><td class="textcen outPutConfirmResize">'+z+'</td><td class="textcen outPutConfirmResize">'+A+"</td></tr>")}t();function t(){let is=$("#getPlaybookid").val();if(is>0){$("#btnViewHistory").removeClass("hideclass");$("#btnDeletePlaybook").removeClass("hideclass");$("#pldNotes").attr("readonly");let json={id:is};$.ajax({type:"GET",url:"/nera/playbook/api/get-by-id",data:json,contentType:"application/json",success:function(C){$("#pldGetPlaybookName").val(C.name);let versionPlaybook=C.version==0?1:C.version;$("#txtVersionPlaybook").text("Version "+versionPlaybook);h(C.sourceUrl);$(".displayitem").attr("data-value",C.sourceUrl);let sta=C.status;$(".forstatus").attr("data-value",sta);if(sta=="NEW"){$(".staNew").removeClass("hideclass");if(hasDeleteNewPermission){$("#btnDeletePlaybook").removeClass("hideclass")}else{$("#btnDeletePlaybook").addClass("hideclass")}}if(sta=="DRAFT"){$(".staDra").removeClass("hideclass")}if(sta=="APPROVED"){$(".staApp").removeClass("hideclass");$(".layValiRemark").removeClass("hideclass");$("#pldRemark").attr("readonly","");$("#btnCreateNewPlaybook").removeClass("hideclass");$("#btnCreateAndSendToApproved").addClass("hideclass");if(hasDeletePermission){$("#btnDeletePlaybook").removeClass("hideclass")}else{$("#btnDeletePlaybook").addClass("hideclass")}}if(sta=="REJECTED"){$(".staRej").removeClass("hideclass");$(".layValiRemark").removeClass("hideclass");$("#btnCreateNewPlaybook").addClass("hideclass");$("#btnCreateAndSendToApproved").addClass("hideclass");if(hasDeletePermission){$("#btnDeletePlaybook").removeClass("hideclass")}else{$("#btnDeletePlaybook").addClass("hideclass")}}$("#pldNotes").val(C.note);$("#pldRemark").val(C.remark);if(C.active==true){$("#radioA").prop("checked",true)}else{$("#radioI").prop("checked",true)}$("#tblPlaybookInput").removeClass("hideclass");if(C.playbookInput.length>0){let get=C.playbookInput;for(let i=0;i<get.length;i++){let col1=get[i].type;let col11=1;let col2=get[i].variable;let col3=get[i].value;let checked=get[i].mandatory;let col31;if(get[i].type=="Text"){col31=""}else{col31=get[i].fileManagementId==null?"":get[i].fileManagementId}l(col1,col11,col2,col3,col31,checked)}}$("#tblPlaybookOutput").unbind().removeClass("hideclass");if(C.playbookOutput.length>0){var z=C.playbookOutput;for(let i=0;i<z.length;i++){var A=z[i].variable;var B=z[i].value;v(A,B)}}}})}}function h(z){if(z==""){return false}$("#getContenOfFile").load(z,function(B,A,C){if(A=="success"){$(".displayitem").append("<span>"+z.split("/").pop()+"</span>")}if(A=="error"){console.log("Error: "+C.status+", "+C.statusText)}})}$("#btnBackToPlay").on("click",function(){if($("#getPlaybookid").val()>0){window.location.href="../../playbook"}else{window.location.href="../playbook"}});$("#btnDeletePlaybook").on("click",function(){$("#kt_modal_Delete").modal("show")});$("#btnYesDelete").on("click",function(){var z=$("#getPlaybookid").val();$("#kt_modal_Delete").modal("hide");$.ajax({type:"POST",url:"/nera/playbook/api/check-used-by-workflow",data:{id:z},success:function(A){if(A){Swal.fire({text:"The current playbook is used by the workflow. Cannot delete",type:"error",timer:3000,showConfirmButton:false})}else{o(z)}}})});function o(z){$.ajax({type:"POST",url:"/nera/playbook/api/delete-by-id",data:{id:z},beforeSend:function(){},success:function(A){q();$(".displaymessage").removeClass("hideclass");$(".deletemess").removeClass("hideclass");setTimeout(function(){window.location.href="../../playbook"},2000)},error:function(A){}})}function q(){$.ajax({type:"GET",url:"/nera/playbook/api/count-approved-playbook",beforeSend:function(){},success:function(z){$(".setPlaybookApprovedCount").text("Playbook Approved ("+z+")")},error:function(z){}})}$("#btnViewHistory").on("click",function(){window.location.href="/menu/masterdata/playbook/history/"+$("#getPlaybookid").val()})});